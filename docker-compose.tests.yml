version: '3.5'

services:
  onetl_tests:
    image: ${TEST_IMAGE}
    depends_on:
    - postgres
    - hive2
    - oracle
    - clickhouse
    - mysql
    env_file:
    - onetl_local.default.env
    environment:
      WAIT: 140
    working_dir: /opt/project
    volumes:
    - /data/onetools:/data/onetools
    - /etc/localtime:/etc/localtime
    networks:
    - onetl
    command: bash -c 'pytest --verbose -s -c pytest.ini tests --cov-append --cov=onetl --cov-config=tests/.coveragerc --cov-report=xml:${COVERAGE_FILE} --junitxml=${JUNIT_FILE}'

  postgres:
    # TODO: fix later
    build:
      context: ./docker/postgres/
      dockerfile: Dockerfile
    env_file: onetl_local.default.env
    restart: always
    networks:
    - onetl

  hive2:
    # TODO: fix later
    build:
      context: ./docker/hive2
      dockerfile: Dockerfile
    env_file: onetl_local.default.env
    hostname: hive2
    networks:
    - onetl

  oracle:
    build:
      context: ./docker/oracle
      dockerfile: Dockerfile
    restart: always
    env_file: onetl_local.default.env
    networks:
    - onetl
    hostname: oracle
    depends_on:
    - postgres

  clickhouse:
    hostname: clickhouse
    image: yandex/clickhouse-server
    env_file: onetl_local.default.env
    networks:
    - onetl

  mysql:
    image: mysql
    env_file: onetl_local.default.env
    networks:
    - onetl

networks:
  onetl:
    name: onetl-${CI_PIPELINE_ID}
